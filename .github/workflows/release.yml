name: "Android Build & Release"

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-android:
    name: Build & Release Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set Up Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Set Up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      - name: Generate Localization Files
        run: flutter gen-l10n

      - name: Build APK
        run: flutter build apk --release

      - name: Build App Bundle
        run: flutter build appbundle

      - name: Install jq for JSON parsing
        run: sudo apt-get install jq

      - name: Upload to Pgyer
        id: pgyer-upload
        env:
          PGYER_API_KEY: ${{ secrets.PGYER_API_KEY }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          # åˆå§‹åŒ–é»˜è®¤è¾“å‡ºå€¼
          echo "PGYER_SUCCESS=false" >> $GITHUB_OUTPUT
          echo "PGYER_ERROR=æœªçŸ¥é”™è¯¯" >> $GITHUB_OUTPUT
          
          # ====== ç­–ç•¥1: ä½¿ç”¨æ¨èçš„æ–°ç‰ˆä¸¤æ­¥ä¸Šä¼ API ======
          echo "ç­–ç•¥1: ä½¿ç”¨æ–°ç‰ˆä¸¤æ­¥ä¸Šä¼ API..."
          
          # 1. è·å–ä¸Šä¼ ä»¤ç‰Œ
          echo "æ­£åœ¨è·å–ä¸Šä¼ ä»¤ç‰Œ..."
          TOKEN_RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "_api_key=$PGYER_API_KEY&buildType=android&buildInstallType=1&buildUpdateDescription=è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ $GITHUB_REF_NAME" \
            https://api.pgyer.com/apiv2/app/getCOSToken)
          
          echo "ä»¤ç‰Œå“åº”: $(echo $TOKEN_RESPONSE | jq '.')"
          
          # æ£€æŸ¥è·å–tokenæ˜¯å¦æˆåŠŸ
          CODE=$(echo $TOKEN_RESPONSE | jq -r '.code')
          if [ "$CODE" != "0" ]; then
            echo "::warning::è·å–ä¸Šä¼ ä»¤ç‰Œå¤±è´¥ï¼Œé”™è¯¯ä»£ç : $CODE"
            echo "åˆ‡æ¢åˆ°å¤‡é€‰ç­–ç•¥..."
            STRATEGY=2
          else
            # è§£æå‚æ•°
            ENDPOINT=$(echo $TOKEN_RESPONSE | jq -r '.data.endpoint')
            KEY=$(echo $TOKEN_RESPONSE | jq -r '.data.key')
            SIGNATURE=$(echo $TOKEN_RESPONSE | jq -r '.data.params.signature')
            TOKEN=$(echo $TOKEN_RESPONSE | jq -r '.data.params."x-cos-security-token"')
            
            # æ£€æŸ¥å…³é”®å‚æ•°
            if [ -z "$ENDPOINT" ] || [ -z "$KEY" ] || [ -z "$SIGNATURE" ] || [ -z "$TOKEN" ]; then
              echo "::warning::å…³é”®å‚æ•°è§£æå¤±è´¥"
              echo "åˆ‡æ¢åˆ°å¤‡é€‰ç­–ç•¥..."
              STRATEGY=2
            else
              STRATEGY=1
            fi
          fi
          
          # å¦‚æœä¸Šé¢çš„æ­¥éª¤æˆåŠŸï¼Œç»§ç»­ç¬¬ä¸€ä¸ªç­–ç•¥
          if [ "$STRATEGY" = "1" ]; then
            # 2. ç«‹å³ä¸Šä¼ æ–‡ä»¶ï¼Œå‡å°‘å»¶è¿Ÿ
            echo "å¼€å§‹ä¸Šä¼ APKåˆ°: $ENDPOINT"
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
            
            # ä½¿ç”¨æ­£ç¡®çš„Content-Typeå’Œå‚æ•°æ ¼å¼
            UPLOAD_RESULT=$(curl -s -X POST -i \
              -F "key=$KEY" \
              -F "signature=$SIGNATURE" \
              -F "x-cos-security-token=$TOKEN" \
              -F "x-cos-meta-file-name=app-release.apk" \
              -F "file=@$APK_PATH" \
              "$ENDPOINT")
            
            # æ£€æŸ¥HTTPçŠ¶æ€ç 
            if ! echo "$UPLOAD_RESULT" | grep -q "204 No Content"; then
              echo "::warning::æ–‡ä»¶ä¸Šä¼ å¤±è´¥"
              echo "ä¸Šä¼ ç»“æœ: $UPLOAD_RESULT"
              echo "åˆ‡æ¢åˆ°å¤‡é€‰ç­–ç•¥..."
              STRATEGY=2
            else
              echo "æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œæ£€æŸ¥åº”ç”¨å‘å¸ƒçŠ¶æ€..."
              
              # 3. æ£€æŸ¥å‘å¸ƒçŠ¶æ€
              MAX_ATTEMPTS=12
              ATTEMPTS=0
              SUCCESS=false
              
              while [ $ATTEMPTS -lt $MAX_ATTEMPTS ]; do
                BUILD_INFO=$(curl -s -X GET \
                  "https://api.pgyer.com/apiv2/app/buildInfo?_api_key=$PGYER_API_KEY&buildKey=$KEY")
                
                CODE=$(echo $BUILD_INFO | jq -r '.code')
                
                if [ "$CODE" = "0" ]; then
                  # å‘å¸ƒæˆåŠŸ
                  BUILD_URL=$(echo $BUILD_INFO | jq -r '.data.buildQRCodeURL')
                  BUILD_NAME=$(echo $BUILD_INFO | jq -r '.data.buildName')
                  BUILD_VERSION=$(echo $BUILD_INFO | jq -r '.data.buildVersion')
                  SHORT_URL=$(echo $BUILD_INFO | jq -r '.data.buildShortcutUrl')
                  
                  echo "âœ… åº”ç”¨å‘å¸ƒæˆåŠŸï¼"
                  echo "åº”ç”¨åç§°: $BUILD_NAME"
                  echo "ç‰ˆæœ¬: $BUILD_VERSION"
                  echo "ä¸‹è½½é“¾æ¥: https://www.pgyer.com/$SHORT_URL"
                  
                  echo "PGYER_SUCCESS=true" >> $GITHUB_OUTPUT
                  echo "PGYER_DOWNLOAD_URL=https://www.pgyer.com/$SHORT_URL" >> $GITHUB_OUTPUT
                  echo "PGYER_QRCODE_URL=$BUILD_URL" >> $GITHUB_OUTPUT
                  echo "PGYER_STRATEGY=æ–°ç‰ˆä¸¤æ­¥ä¸Šä¼ API" >> $GITHUB_OUTPUT
                  SUCCESS=true
                  break
                elif [ "$CODE" = "1216" ]; then
                  # å‘å¸ƒå¤±è´¥
                  MESSAGE=$(echo $BUILD_INFO | jq -r '.message')
                  echo "::warning::åº”ç”¨å‘å¸ƒå¤±è´¥: $MESSAGE"
                  break
                elif [ "$CODE" = "1247" ]; then
                  # æ­£åœ¨å¤„ç†ä¸­
                  echo "â³ åº”ç”¨æ­£åœ¨å¤„ç†ä¸­... (å°è¯• $((ATTEMPTS+1))/$MAX_ATTEMPTS)"
                  ATTEMPTS=$((ATTEMPTS+1))
                  sleep 5
                else
                  # æœªçŸ¥çŠ¶æ€
                  echo "âš ï¸ æœªçŸ¥çŠ¶æ€ï¼Œä»£ç : $CODE"
                  ATTEMPTS=$((ATTEMPTS+1))
                  sleep 5
                fi
                
                if [ $ATTEMPTS -eq $MAX_ATTEMPTS ]; then
                  echo "::warning::è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°"
                  echo "åˆ‡æ¢åˆ°å¤‡é€‰ç­–ç•¥..."
                  STRATEGY=2
                fi
              done
              
              # å¦‚æœå·²ç»æˆåŠŸï¼Œä¸å†æ‰§è¡Œå¤‡é€‰ç­–ç•¥
              if [ "$SUCCESS" = "true" ]; then
                exit 0
              fi
            fi
          fi
          
          # ====== ç­–ç•¥2: ä½¿ç”¨æ—§ç‰ˆå•æ­¥ä¸Šä¼ APIä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ ======
          if [ "$STRATEGY" = "2" ]; then
            echo "ç­–ç•¥2: ä½¿ç”¨æ—§ç‰ˆå•æ­¥ä¸Šä¼ API..."
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
            
            UPLOAD_RESPONSE=$(curl -s -F "file=@$APK_PATH" \
              -F "_api_key=$PGYER_API_KEY" \
              -F "buildInstallType=1" \
              -F "buildUpdateDescription=è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ $GITHUB_REF_NAME" \
              https://api.pgyer.com/apiv2/app/upload)
            
            echo "ä¸Šä¼ å“åº”: $(echo $UPLOAD_RESPONSE | jq '.')"
            
            CODE=$(echo $UPLOAD_RESPONSE | jq -r '.code')
            if [ "$CODE" = "0" ]; then
              # ä¸Šä¼ æˆåŠŸ
              BUILD_KEY=$(echo $UPLOAD_RESPONSE | jq -r '.data.buildKey')
              BUILD_NAME=$(echo $UPLOAD_RESPONSE | jq -r '.data.buildName')
              BUILD_VERSION=$(echo $UPLOAD_RESPONSE | jq -r '.data.buildVersion')
              SHORT_URL=$(echo $UPLOAD_RESPONSE | jq -r '.data.buildShortcutUrl')
              QR_CODE_URL=$(echo $UPLOAD_RESPONSE | jq -r '.data.buildQRCodeURL')
              
              echo "âœ… åº”ç”¨ä¸Šä¼ æˆåŠŸï¼"
              echo "åº”ç”¨åç§°: $BUILD_NAME"
              echo "ç‰ˆæœ¬: $BUILD_VERSION"
              echo "ä¸‹è½½é“¾æ¥: https://www.pgyer.com/$SHORT_URL"
              
              echo "PGYER_SUCCESS=true" >> $GITHUB_OUTPUT
              echo "PGYER_DOWNLOAD_URL=https://www.pgyer.com/$SHORT_URL" >> $GITHUB_OUTPUT
              echo "PGYER_QRCODE_URL=$QR_CODE_URL" >> $GITHUB_OUTPUT
              echo "PGYER_STRATEGY=æ—§ç‰ˆå•æ­¥ä¸Šä¼ API" >> $GITHUB_OUTPUT
            else
              # ä¸Šä¼ å¤±è´¥
              MESSAGE=$(echo $UPLOAD_RESPONSE | jq -r '.message')
              echo "::error::åº”ç”¨ä¸Šä¼ å¤±è´¥: $MESSAGE"
              echo "PGYER_ERROR=åº”ç”¨ä¸Šä¼ å¤±è´¥: $MESSAGE" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
          generate_release_notes: true
          draft: false
          body: |
            ## å¼€çœ¼ App è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ ${{ github.ref_name }}
            
            ${{ steps.pgyer-upload.outputs.PGYER_SUCCESS == 'true' && '### ğŸ“± è’²å…¬è‹±ä¸‹è½½' || '### âš ï¸ è’²å…¬è‹±ä¸Šä¼ çŠ¶æ€' }}
            ${{ steps.pgyer-upload.outputs.PGYER_SUCCESS == 'true' && format('- ğŸ”— ä¸‹è½½é“¾æ¥: {0}', steps.pgyer-upload.outputs.PGYER_DOWNLOAD_URL) || format('- âŒ é”™è¯¯ä¿¡æ¯: {0}', steps.pgyer-upload.outputs.PGYER_ERROR) }}
            ${{ steps.pgyer-upload.outputs.PGYER_SUCCESS == 'true' && format('- ğŸ“± æ‰«ç å®‰è£…: {0}', steps.pgyer-upload.outputs.PGYER_QRCODE_URL) || '' }}
            ${{ steps.pgyer-upload.outputs.PGYER_SUCCESS == 'true' && format('- ğŸ”§ ä¸Šä¼ æ–¹å¼: {0}', steps.pgyer-upload.outputs.PGYER_STRATEGY) || '' }}
            
            ### ğŸ“¦ ä¸‹è½½å†…å®¹
            
            - APK: é€‚ç”¨äºç›´æ¥å®‰è£…çš„å®‰å“åº”ç”¨åŒ…
            - AAB: Google Play åº”ç”¨åŒ…æ ¼å¼
            
            ---
            
            è‡ªåŠ¨æ„å»ºäº ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}